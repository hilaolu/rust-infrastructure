kind: pipeline
type: docker
name: default

steps:
- name: build
  image: rust:latest
  commands: 
  - apt install libssl-dev openssl pkg-config git fish -y
  - fish cargo-screeps.fish
  - git clone https://github.com/sozu-proxy/sozu.git
  - cd sozu
  - cd bin && cargo build --release --features use-openssl
  - mkdir /release/bin
  - cd ../ctl && cargo build --release
  - cd ..
  - cp target/release/sozu /release/bin  
  - cp target/release/sozuctl /release/bin  
  volumes:
  - name: release 
    path: /release 

- name: publish
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files: 
      - /release/bin/*
  volumes:
  - name: release 
    path: /release 
  when:
    event: tag
    
volumes:
- name: release
  temp: {}